#!/bin/bash
set -e

# Pre-removal script for proxmox-lxcri

case "$1" in
    remove|deconfigure)
        # Stop the service if it's running
        if [ -d /run/systemd/system ]; then
            systemctl stop proxmox-lxcri.service || true
            systemctl disable proxmox-lxcri.service || true
        fi
        
        # Stop any running containers gracefully
        if command -v proxmox-lxcri >/dev/null 2>&1; then
            echo "Stopping any running containers..."
            proxmox-lxcri list 2>/dev/null | awk 'NR>1 && $3=="running" {print $1}' | while read container; do
                echo "Stopping container: $container"
                proxmox-lxcri stop "$container" || true
            done
        fi
        ;;
    
    upgrade|failed-upgrade)
        # Don't stop service during upgrade
        ;;
    
    *)
        echo "prerm called with unknown argument \`$1'" >&2
        exit 1
        ;;
esac

#DEBHELPER#

exit 0
