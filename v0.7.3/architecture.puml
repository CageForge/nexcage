@startuml

!theme plain
skinparam backgroundColor transparent
skinparam componentStyle rectangle

' Level 1: System Context
title System Context Diagram

actor "Kubernetes" as k8s
actor "System Admin" as admin
actor "Developer" as dev

system "Proxmox LXCRI" as lxcri {
    system "Container Runtime" as runtime
    system "Storage System" as storage
    system "Network System" as network
    system "Security System" as security
}

system "Proxmox VE" as proxmox {
    system "LXC Runtime" as lxc
    system "ZFS Storage" as zfs
    system "Network Stack" as netstack
}

k8s --> lxcri : Container Management
admin --> lxcri : Configuration
dev --> lxcri : Development
lxcri --> proxmox : Resource Management

' Level 2: Container Diagram
title Container Diagram

container "containerd" as ctrd {
    component "CRI Plugin" as cri
    component "OCI Runtime" as oci
}

container "Proxmox LXCRI" as lxcri {
    container "Runtime Service" as runtime {
        component "State Manager" as state
        component "Hook System" as hooks
        component "Bundle Validator" as validator
    }
    
    container "Storage Service" as storage {
        component "Dataset Manager" as dataset
        component "Layer Manager" as layer
        component "Image Manager" as image
    }
    
    container "Network Service" as network {
        component "VLAN Manager" as vlan
        component "Bridge Manager" as bridge
        component "IP Manager" as ip
    }
    
    container "Security Service" as security {
        component "AppArmor/SELinux" as lsm
        component "Seccomp" as seccomp
        component "Capabilities" as caps
    }
}

container "Proxmox VE" as proxmox {
    container "LXC Runtime" as lxc
    container "ZFS Storage" as zfs
    container "Network Stack" as netstack
}

ctrd --> runtime : OCI Spec
runtime --> storage : Storage Operations
runtime --> network : Network Configuration
runtime --> security : Security Policies
storage --> zfs : Dataset Management
network --> netstack : Network Setup
security --> lxc : Security Profiles

' Level 3: Component Diagram
title Component Diagram

component "Runtime Service" as runtime {
    component "State Manager" as state {
        component "Container State" as cstate
        component "State Storage" as sstorage
    }
    
    component "Hook System" as hooks {
        component "Hook Executor" as executor
        component "Hook Context" as context
    }
    
    component "Bundle Validator" as validator {
        component "Spec Validator" as spec
        component "Config Validator" as config
    }
}

component "Storage Service" as storage {
    component "Dataset Manager" as dataset {
        component "ZFS Operations" as zfsops
        component "Dataset Config" as dsconfig
    }
    
    component "Layer Manager" as layer {
        component "Layer Storage" as lstorage
        component "Layer Operations" as lops
    }
    
    component "Image Manager" as image {
        component "Image Storage" as istorage
        component "Image Operations" as iops
    }
}

component "Network Service" as network {
    component "VLAN Manager" as vlan {
        component "VLAN Config" as vconfig
        component "VLAN Operations" as vops
    }
    
    component "Bridge Manager" as bridge {
        component "Bridge Config" as bconfig
        component "Bridge Operations" as bops
    }
    
    component "IP Manager" as ip {
        component "IP Config" as ipconfig
        component "IP Operations" as ipops
    }
}

component "Security Service" as security {
    component "AppArmor/SELinux" as lsm {
        component "Profile Manager" as profile
        component "Policy Enforcer" as policy
    }
    
    component "Seccomp" as seccomp {
        component "Filter Manager" as filter
        component "Profile Loader" as loader
    }
    
    component "Capabilities" as caps {
        component "Cap Manager" as capman
        component "Cap Enforcer" as capenf
    }
}

' Level 4: Code Diagram
title Code Diagram

class "ContainerState" as cstate {
    +id: string
    +status: ContainerStatus
    +pid: int
    +bundle: string
    +created: DateTime
    +started: DateTime
    +finished: DateTime
    +exitCode: int
    +updateStatus()
    +saveState()
    +loadState()
}

class "HookExecutor" as executor {
    -allocator: Allocator
    -default_timeout: i64
    +executeHook()
    +executeHooks()
    +init()
    +deinit()
}

class "HookContext" as context {
    +container_id: string
    +bundle: string
    +state: string
    +create()
    +validate()
}

class "DatasetManager" as dataset {
    -zfs_manager: *ZFSManager
    +createDataset()
    +destroyDataset()
    +listDatasets()
    +getDatasetInfo()
}

class "LayerManager" as layer {
    -storage: *LayerStorage
    +createLayer()
    +deleteLayer()
    +mountLayer()
    +unmountLayer()
}

class "ImageManager" as image {
    -storage: *ImageStorage
    +pullImage()
    +pushImage()
    +deleteImage()
    +listImages()
}

@enduml 