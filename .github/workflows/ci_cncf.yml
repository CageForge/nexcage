name: CI (CNCF Compliant)

on:
  push:
    branches: [ main, develop, feature/**, feat/** ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  packages: read
  security-events: write
  actions: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  XDG_CACHE_HOME: ${{ github.workspace }}/.cache

jobs:
  vendored-build:
    name: Vendored Build (ubuntu-latest)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1
      - name: Install system dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            build-essential autoconf automake libtool pkg-config \
            libyajl-dev libcap-dev libseccomp-dev libsystemd-dev \
            libbpf-dev libapparmor-dev libselinux1-dev libcriu-dev
      - name: Prepare vendored headers
        run: zig build prepare-crun
      - name: Build vendored
        run: zig build -Duse-vendored-libcrun=true --summary all

  # Build and test on multiple runners (same arch: amd64)
  build-test:
    name: Build and Test (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: [self-hosted, proxmox]
            name: proxmox-amd64
          - os: [self-hosted, runner0]
            name: runner0-amd64

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: 0.15.1

    - name: Build Debug
      run: zig build

    - name: Build Release
      run: zig build -Doptimize=ReleaseFast

    - name: Run unit tests
      run: zig build test
      # Make tests mandatory (fail-fast) for CI gates
      continue-on-error: false

    - name: Smoke tests
      run: |
        ./zig-out/bin/nexcage --help || exit 1
        ./zig-out/bin/nexcage version || exit 1
        ./zig-out/bin/nexcage create --help || exit 1
        ./zig-out/bin/nexcage list --runtime proxmox-lxc || exit 1
      # Make smoke tests mandatory
      continue-on-error: false

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nexcage-${{ matrix.name }}
        path: zig-out/bin/nexcage
        retention-days: 7

  # Code quality and formatting
  quality:
    name: Code Quality
    runs-on: [self-hosted, runner0]
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: 0.15.1

    - name: Check code formatting
      run: zig fmt --check src/ || echo "Format check failed (non-fatal)"

    - name: Analyze code
      run: |
        # Basic static analysis
        find src/ -name "*.zig" -exec echo "Analyzing: {}" \; || true
        zig build --help | head -20 || true

  # Performance testing
  performance:
    name: Performance Tests
    runs-on: [self-hosted, runner0]
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: 0.15.1

    - name: Build optimized
      run: zig build -Doptimize=ReleaseFast

    - name: Performance benchmarks
      run: |
        echo "Running performance tests..."
        time ./zig-out/bin/nexcage --help > /dev/null || true
        time ./zig-out/bin/nexcage version > /dev/null || true
        
        # Memory usage test
        echo "Memory usage test:"
        /usr/bin/time -v ./zig-out/bin/nexcage --help 2>&1 | grep -E "Maximum resident|User time|System time" || true

  # Integration tests (if Proxmox available)
  integration:
    name: Integration Tests
    runs-on: [self-hosted, proxmox]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    # Make integration tests mandatory when conditions are met
    continue-on-error: false
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: 0.15.1

    - name: Build
      run: zig build -Doptimize=ReleaseFast

    - name: Integration tests
      run: |
        echo "Running integration tests on Proxmox..."
        ./zig-out/bin/nexcage --help || exit 1
        ./zig-out/bin/nexcage version || exit 1
        
        # Test with actual Proxmox tools
        if ! command -v pct; then
          echo "ERROR: pct not available"
          exit 1
        fi
        pct version || exit 1
        
        if ! command -v pveversion; then
          echo "ERROR: pveversion not available"
          exit 1
        fi
        pveversion -v || exit 1

    - name: Upload integration artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nexcage-integration-amd64
        path: zig-out/bin/nexcage
        retention-days: 7
