name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag to build (e.g., v0.7.2)'
        required: true
        type: string
        default: 'v0.7.2'

permissions:
  contents: write

jobs:
  build:
    name: Build Release Binaries
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-linux
            arch: amd64
            artifact_name: nexcage-linux-x86_64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version || github.ref }}

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1

      - name: Extract version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION=${{ github.event.inputs.version }}
            VERSION=${VERSION#v}
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build
        run: |
          zig build -Doptimize=ReleaseFast

      - name: Create artifact
        id: build
        run: |
          mkdir -p dist
          BIN_NAME=nexcage-${{ steps.get_version.outputs.version }}-${{ matrix.arch }}
          cp zig-out/bin/nexcage "dist/${BIN_NAME}"
          chmod +x "dist/${BIN_NAME}"
          
          # Generate SHA256 hash for SLSA provenance
          SHA256=$(sha256sum "dist/${BIN_NAME}" | cut -d' ' -f1)
          echo "sha256=${SHA256}" >> $GITHUB_OUTPUT
          echo "artifact_path=dist/${BIN_NAME}" >> $GITHUB_OUTPUT

      - name: Generate SBOM (SPDX JSON)
        uses: anchore/sbom-action@v0
        with:
          path: dist
          artifact-name: nexcage-${{ steps.get_version.outputs.version }}-${{ matrix.arch }}.sbom
          output-file: dist/nexcage-${{ steps.get_version.outputs.version }}-${{ matrix.arch }}.sbom.spdx.json
          format: spdx-json

      - name: Generate SBOM (CycloneDX JSON)
        uses: cyclonedx/cyclonedx-action@v1
        with:
          output-format: json
          output-file: dist/nexcage-${{ steps.get_version.outputs.version }}-${{ matrix.arch }}.sbom.cdx.json
          # Scan the built binary and source code
          build-dir: .
          scan-targets: dist/${BIN_NAME}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nexcage-${{ steps.get_version.outputs.version }}-${{ matrix.arch }}
          path: dist/nexcage-${{ steps.get_version.outputs.version }}-${{ matrix.arch }}

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nexcage-${{ steps.get_version.outputs.version }}-${{ matrix.arch }}.sbom
          path: |
            dist/nexcage-${{ steps.get_version.outputs.version }}-${{ matrix.arch }}.sbom.spdx.json
            dist/nexcage-${{ steps.get_version.outputs.version }}-${{ matrix.arch }}.sbom.cdx.json

      - name: Generate SLSA Provenance
        id: slsa
        continue-on-error: true  # SLSA requires additional setup
        run: |
          # Generate minimal SLSA provenance (will be enhanced later)
          ARTIFACT_PATH="${{ steps.build.outputs.artifact_path }}"
          SHA256="${{ steps.build.outputs.sha256 }}"
          
          # Create provenance directory
          mkdir -p dist
          
          # Generate basic provenance JSON
          cat > dist/provenance.json << EOF
          {
            "_type": "https://in-toto.io/Statement/v1",
            "subject": [
              {
                "name": "${{ steps.build.outputs.artifact_path }}",
                "digest": {
                  "sha256": "${SHA256}"
                }
              }
            ],
            "predicateType": "https://slsa.dev/provenance/v1",
            "predicate": {
              "buildDefinition": {
                "buildType": "https://github.com/actions/v1",
                "externalParameters": {
                  "workflow": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                }
              }
            }
          }
          EOF
          
          echo "SLSA provenance generated"

      - name: Upload SLSA Provenance
        uses: actions/upload-artifact@v4
        if: steps.slsa.outcome == 'success'
        with:
          name: nexcage-${{ steps.get_version.outputs.version }}-${{ matrix.arch }}.provenance
          path: dist/provenance.json

  build-deb:
    name: Build DEB Packages
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-22.04
            arch: amd64
            target: x86_64-linux

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version || github.ref }}

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            debhelper \
            devscripts \
            build-essential \
            fakeroot \
            lintian \
            dh-systemd

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1

      # Single-arch (amd64) only per product constraints

      - name: Extract version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION=${{ github.event.inputs.version }}
            VERSION=${VERSION#v}
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "debian_version=${VERSION}-1" >> $GITHUB_OUTPUT

      - name: Prepare changelog
        run: |
          # Ensure changelog exists and update version
          VERSION=${{ steps.get_version.outputs.version }}
          DEB_VERSION="${VERSION}-1"
          
          # Update changelog if it exists, or create it
          if [ -f packaging/debian/changelog ]; then
            sed -i "1s/.*/nexcage (${DEB_VERSION}) stable; urgency=medium/" packaging/debian/changelog || true
          fi

      - name: Build DEB package (amd64)
        run: |
          # Create source tarball
          VERSION=${{ steps.get_version.outputs.version }}
          mkdir -p ../dist
          
          # Copy source to build directory
          mkdir -p ../build-deb
          cp -r . ../build-deb/nexcage-${VERSION}
          cd ../build-deb/nexcage-${VERSION}
          
          # Update changelog with current version
          dch --newversion "${VERSION}-1" --distribution stable "Release v${VERSION}" || \
          sed -i "1s/.*/nexcage (${VERSION}-1) stable; urgency=medium\n\n  * Release v${VERSION}\n\n -- NexCage Team <maintainers@nexcage.io>  $(date -R)/" packaging/debian/changelog
          
          # Build package (non-interactive, no signing)
          DEB_BUILD_OPTIONS=nocheck dpkg-buildpackage -us -uc -b
          
          # Move packages to dist
          cd ..
          mv *.deb ../dist/
          mv *.dsc ../dist/ 2>/dev/null || true
          mv *.tar.* ../dist/ 2>/dev/null || true
          mv *.changes ../dist/ 2>/dev/null || true
          
          # Rename with version
          cd ../dist
          for f in nexcage*.deb; do
            mv "$f" "nexcage-${VERSION}-amd64.deb" 2>/dev/null || true
          done

      - name: Test DEB package
        if: matrix.arch == 'amd64'
        run: |
          # Install dependencies
          sudo apt-get update
          
          # Install the package (allow conflicts for testing)
          sudo dpkg -i dist/nexcage-*.deb || sudo apt-get install -f -y
          
          # Basic functionality test
          nexcage version || echo "Version check failed (non-fatal)"
          nexcage --help || echo "Help check failed (non-fatal)"
          
          # Verify binary location
          which nexcage || echo "Binary not in PATH (non-fatal)"

      - name: Run lintian checks
        run: |
          lintian dist/*.deb || echo "Lintian warnings found (non-fatal)"

      - name: Upload DEB artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nexcage-${{ steps.get_version.outputs.version }}-${{ matrix.arch }}.deb
          path: dist/*.deb

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build, build-deb]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          # Binaries
          find artifacts -name "nexcage-*" -type f ! -name "*.sbom*" ! -name "*.provenance*" -exec cp {} release/ \;
          # SBOMs (SPDX JSON and CycloneDX JSON)
          find artifacts -name "*.sbom*" -type f -exec cp {} release/ \;
          # SLSA Provenance
          find artifacts -name "*.provenance*" -type f -exec cp {} release/ \; || true
          ls -la release/

      - name: Create checksums
        run: |
          cd release
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Extract release notes
        id: extract_notes
        run: |
          # Extract release notes from CHANGELOG.md for current version
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION=${{ github.event.inputs.version }}
            VERSION=${VERSION#v}
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "Extracting notes for version $VERSION"
          
          # Create release notes
          if [ -f "docs/releases/NOTES_v${VERSION}.md" ]; then
            echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
            cat docs/releases/NOTES_v${VERSION}.md >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
            echo "Release v${VERSION}" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "See CHANGELOG.md for details." >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/*
          body: ${{ steps.extract_notes.outputs.RELEASE_NOTES }}
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}