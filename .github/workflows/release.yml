name: Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        run: git checkout ${{ github.ref }}
      - name: Setup Node.js
        run: |
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs
      - name: Create Release
        run: |
          RELEASE_TAG=$(git describe --tags --abbrev=0)
          RELEASE_BODY=$(git log -1 --pretty=%B)
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"tag_name\":\"$RELEASE_TAG\",\"name\":\"$RELEASE_TAG\",\"body\":\"$RELEASE_BODY\",\"draft\":false,\"prerelease\":false}" \
            "https://api.github.com/repos/${{ github.repository }}/releases"
      - name: Install Dependencies
        run: npm ci
      - name: Build Plugins
        run: npm run build:plugins
      - name: Generate gRPC Code
        run: npm run generate:grpc
      - name: Build Release
        run: npm run build:release
      - name: Create Release Asset
        run: |
          mkdir -p dist
          cp -r build/* dist/
          tar -czf release.tar.gz dist/
      - name: Upload Release Asset
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/gzip" \
            --data-binary @release.tar.gz \
            "https://uploads.github.com/repos/${{ github.repository }}/releases/${{ github.event.release.id }}/assets?name=release.tar.gz" 