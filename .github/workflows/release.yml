name: Release on VERSION change

on:
  push:
    branches: [ main, master, "feat/**" ]
    paths:
      - VERSION

jobs:
  release:
    permissions:
      contents: write
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read version
        id: ver
        run: echo "version=$(tr -d '\n\r' < VERSION)" >> $GITHUB_OUTPUT

      - name: Setup Zig 0.15.1
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1

      - name: Install deps
        run: sudo apt-get update && sudo apt-get install -y libcap-dev libseccomp-dev libyajl-dev

      - name: Build
        run: zig build -Doptimize=ReleaseSafe

      - name: Build packaging artifacts
        run: bash scripts/ci/build_artifacts.sh

      - name: Create tag if missing
        id: tag
        run: |
          VERSION="v${{ steps.ver.outputs.version }}"
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "tag_exists=true" >> $GITHUB_OUTPUT
          else
            git tag "$VERSION"
            git push origin "$VERSION"
            echo "tag_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.ver.outputs.version }}
          name: Proxmox LXCRI v${{ steps.ver.outputs.version }}
          body: |
            Automated release from VERSION change.
          draft: false
          prerelease: false
          files: |
            zig-out/bin/nexcage
            dist/*.tar.gz
            dist/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build Release Binaries
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-linux
            arch: amd64
            artifact_name: nexcage-linux-x86_64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1

      - name: Extract version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build
        run: |
          zig build -Doptimize=ReleaseFast

      - name: Create artifact
        run: |
          mkdir -p dist
          BIN_NAME=nexcage-${{ steps.get_version.outputs.version }}-${{ matrix.arch }}
          cp zig-out/bin/nexcage "dist/${BIN_NAME}"
          chmod +x "dist/${BIN_NAME}"

      - name: Generate SBOM (SPDX JSON)
        uses: anchore/sbom-action@v0
        with:
          path: dist
          artifact-name: nexcage-${{ steps.get_version.outputs.version }}-${{ matrix.arch }}.sbom
          output-file: dist/nexcage-${{ steps.get_version.outputs.version }}-${{ matrix.arch }}.sbom.spdx.json
          format: spdx-json

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nexcage-${{ steps.get_version.outputs.version }}-${{ matrix.arch }}
          path: dist/nexcage-${{ steps.get_version.outputs.version }}-${{ matrix.arch }}

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: nexcage-${{ steps.get_version.outputs.version }}-${{ matrix.arch }}.sbom.spdx.json
          path: dist/nexcage-${{ steps.get_version.outputs.version }}-${{ matrix.arch }}.sbom.spdx.json

  build-deb:
    name: Build DEB Packages
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-22.04
            arch: amd64
            target: x86_64-linux

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            debhelper \
            devscripts \
            build-essential \
            fakeroot \
            lintian \
            dh-systemd

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1

      # Single-arch (amd64) only per product constraints

      - name: Extract version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "debian_version=${VERSION}-1" >> $GITHUB_OUTPUT

      - name: Update changelog for current version
        run: |
          sed -i "1s/0\.3\.0-1/${{ steps.get_version.outputs.debian_version }}/" packaging/debian/changelog

      - name: Build DEB package (amd64)
        run: |
          # Create build environment
          mkdir -p build-deb
          cp -r . build-deb/nexcage-${{ steps.get_version.outputs.version }}
          cd build-deb/nexcage-${{ steps.get_version.outputs.version }}
          
          # Build package
          dpkg-buildpackage -us -uc
          
          # Move packages to dist
          cd ..
          mkdir -p ../dist
          cp *.deb ../dist/
          cp *.dsc ../dist/ || true
          cp *.tar.* ../dist/ || true
          cp *.changes ../dist/ || true

      - name: Test DEB package
        if: matrix.arch == 'amd64'
        run: |
          # Install the package in a test environment
          sudo apt-get install -y ./dist/*.deb || true
          
          # Basic functionality test
          nexcage version
          
          # Check if service is available
          systemctl status nexcage || true
          
          # Test help
          nexcage help

      - name: Run lintian checks
        run: |
          lintian dist/*.deb || echo "Lintian warnings found (non-fatal)"

      - name: Upload DEB artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nexcage-${{ steps.get_version.outputs.version }}-${{ matrix.arch }}.deb
          path: dist/*.deb

  release:
    name: Create Release
    runs-on: [proxmox]
    needs: [build, build-deb]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          # Binaries
          find artifacts -name "nexcage-*" -type f -exec cp {} release/ \;
          # SBOMs (SPDX JSON)
          find artifacts -name "*.sbom.spdx.json" -type f -exec cp {} release/ \;
          ls -la release/

      - name: Create checksums
        run: |
          cd release
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Extract release notes
        id: extract_notes
        run: |
          # Extract release notes from CHANGELOG.md for current version
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Extracting notes for version $VERSION"
          
          # Create release notes
          # TODO: Create release notes from sprint summary
          
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          cat docs/releases/NOTES_v${VERSION}.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/*
          body: ${{ steps.extract_notes.outputs.RELEASE_NOTES }}
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}