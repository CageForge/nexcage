name: Proxmox E2E (Self-Hosted)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: proxmox-e2e-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e:
    name: Proxmox Self-Hosted E2E
    runs-on: [self-hosted, proxmox]

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Print environment info
      run: |
        echo "Runner: $(hostname)"
        echo "Kernel: $(uname -a)"
        echo "User: $(whoami)"
        command -v pct && pct version || true
        command -v pveversion && pveversion -v || true
        command -v zig && zig version || true

    - name: Verify system dependencies (pre-installed)
      run: |
        # Expect libs pre-installed on self-hosted runner (no sudo here)
        ldconfig -p | grep -E 'libcap|libseccomp|libyajl' || true

    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: 0.15.1

    - name: Build (Debug)
      run: zig build

    - name: Smoke tests (no root required)
      run: |
        ./zig-out/bin/proxmox-lxcri --help || true
        ./zig-out/bin/proxmox-lxcri version || true
        # Temporarily skip list to avoid allocator crash on 0.13 zig pre-installed
        # ./zig-out/bin/proxmox-lxcri list --runtime lxc || true

    - name: Upload binary artifact
      uses: actions/upload-artifact@v4
      with:
        name: proxmox-lxcri-selfhosted-amd64
        path: zig-out/bin/proxmox-lxcri
        retention-days: 7

    - name: Prepare E2E log file
      run: |
        : > e2e_lxc.log

    - name: Check LXC template present (pre-seeded requirement)
      run: |
        set -euo pipefail
        export PATH=/usr/sbin:/sbin:/usr/bin:/bin:$PATH
        echo "[E2E] Checking local LXC templates..." | tee -a e2e_lxc.log
        ls -l /var/lib/vz/template/cache/ | sed -n '1,200p' | tee -a e2e_lxc.log || true
        if ! ls -1 /var/lib/vz/template/cache/*.tar.* >/dev/null 2>&1; then
          echo "No LXC template found in /var/lib/vz/template/cache. Pre-seed a template or set TPL env." | tee -a e2e_lxc.log
          exit 1
        fi

    - name: E2E LXC lifecycle (pct create/start/stop/destroy)
      run: |
        set -euo pipefail
        LOG=e2e_lxc.log
        exec > >(tee -a "$LOG") 2>&1
        export PATH=/usr/sbin:/sbin:/usr/bin:/bin:$PATH

        # Sudo helper (non-interactive). Requires NOPASSWD on runner for pct/pvesh/pvesm.
        if command -v sudo >/dev/null 2>&1; then SUDO='sudo -n'; else SUDO=; fi

        # Preflight: verify NOPASSWD works for required tools
        if [ -n "$SUDO" ]; then
          set +e
          $SUDO -v >/dev/null 2>&1
          $SUDO pvesh get /cluster/nextid >/dev/null 2>&1 || { echo "sudo NOPASSWD for pvesh missing" | tee -a "$LOG"; exit 1; }
          $SUDO pvesm status >/dev/null 2>&1 || { echo "sudo NOPASSWD for pvesm missing" | tee -a "$LOG"; exit 1; }
          $SUDO pct status 999999 >/dev/null 2>&1 || true
          set -e
        fi

        echo "[E2E] Detect template (vztmpl)"
        TPL=${TPL:-}
        if [ -z "${TPL}" ]; then
          TPL=$(pvesm list local --content vztmpl 2>/dev/null | awk '/vztmpl/ {print $1; exit}') || true
        fi
        if [ -z "${TPL}" ]; then
          TPL=$(ls -1 /var/lib/vz/template/cache/*.tar.* 2>/dev/null | head -n1) || true
        fi
        if [ -z "${TPL}" ]; then
          echo "No LXC template found (vztmpl). Please ensure a container template exists." >&2
          exit 1
        fi
        echo "Template: $TPL"

        echo "[E2E] Detect rootfs storage"
        ROOTFS=${ROOTFS:-}
        if [ -z "${ROOTFS}" ]; then
          if $SUDO pvesm status | awk '{print $1}' | grep -q '^local-lvm$'; then ROOTFS=local-lvm; else ROOTFS=local; fi
        fi
        echo "ROOTFS: $ROOTFS"

        BRIDGE=vmbr50
        if ! ip -br link 2>/dev/null | awk '{print $1}' | grep -q "^${BRIDGE}$"; then
          echo "Bridge ${BRIDGE} not found. Please ensure vmbr50 exists on the runner." | tee -a "$LOG"
          exit 1
        fi
        echo "BRIDGE: $BRIDGE"

        VMID=$($SUDO pvesh get /cluster/nextid)
        echo "VMID: $VMID"

        cleanup() {
          set +e
          echo "[E2E] Cleanup for VMID=$VMID"
          if [ -n "$SUDO" ]; then
            $SUDO pct stop "$VMID" --timeout 30 >/dev/null 2>&1 || true
            $SUDO pct destroy "$VMID" --purge 1 >/dev/null 2>&1 || true
          else
            pct stop "$VMID" --timeout 30 >/dev/null 2>&1 || true
            pct destroy "$VMID" --purge 1 >/dev/null 2>&1 || true
          fi
        }
        trap cleanup EXIT

        echo "[E2E] Create"
        if echo "$TPL" | grep -q '^local:'; then
          $SUDO pct create "$VMID" "$TPL" \
            -rootfs "${ROOTFS}:2" -memory 256 -hostname "gh-e2e-$VMID" \
            -net0 "name=eth0,bridge=$BRIDGE,ip=dhcp" -cores 1 -features nesting=1,keyctl=1 -unprivileged 0
        else
          $SUDO pct create "$VMID" "$TPL" \
            -rootfs "${ROOTFS}:2" -memory 256 -hostname "gh-e2e-$VMID" \
            -net0 "name=eth0,bridge=$BRIDGE,ip=dhcp" -cores 1 -features nesting=1,keyctl=1 -unprivileged 0
        fi

        echo "[E2E] Start"
        $SUDO pct start "$VMID"
        for i in $(seq 1 30); do
          if $SUDO pct status "$VMID" | grep -q running; then break; fi
          sleep 2
        done
        $SUDO pct status "$VMID"

        echo "[E2E] Exec sanity"
        LXC_MEMFD_REXEC=0 $SUDO pct exec "$VMID" -- sh -lc 'uname -a && id && echo ok'

        echo "[E2E] Stop"
        $SUDO pct stop "$VMID" --timeout 60
        $SUDO pct status "$VMID" || true

        echo "[E2E] Destroy"
        $SUDO pct destroy "$VMID" --purge 1
        trap - EXIT

    - name: Upload E2E logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: proxmox-e2e-logs
        path: e2e_lxc.log
        retention-days: 7
