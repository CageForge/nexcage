name: Proxmox E2E (Self-Hosted)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: proxmox-e2e-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e:
    name: Proxmox Self-Hosted E2E
    runs-on: [self-hosted, proxmox]

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Print environment info
      run: |
        echo "Runner: $(hostname)"
        echo "Kernel: $(uname -a)"
        echo "User: $(whoami)"
        command -v pct && pct version || true
        command -v pveversion && pveversion -v || true
        command -v zig && zig version || true

    - name: Verify system dependencies (pre-installed)
      run: |
        # Expect libs pre-installed on self-hosted runner (no sudo here)
        ldconfig -p | grep -E 'libcap|libseccomp|libyajl' || true

    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: 0.15.1

    - name: Build (Debug)
      run: zig build

    - name: Smoke tests (no root required)
      run: |
        ./zig-out/bin/proxmox-lxcri --help || true
        ./zig-out/bin/proxmox-lxcri version || true
        # Temporarily skip list to avoid allocator crash on 0.13 zig pre-installed
        # ./zig-out/bin/proxmox-lxcri list --runtime lxc || true

    - name: Upload binary artifact
      uses: actions/upload-artifact@v4
      with:
        name: proxmox-lxcri-selfhosted-amd64
        path: zig-out/bin/proxmox-lxcri
        retention-days: 7

    - name: Ensure LXC template exists (pveam download if missing)
      run: |
        set -euo pipefail
        # Pick a small, commonly available template
        TEMPLATE_NAME=${TEMPLATE_NAME:-alpine-3.18-default_20230607_amd64.tar.xz}
        # Prefer 'alpine' if available, else pick first from 'pveam available --section system'
        if pveam available --section system | grep -q alpine; then
          TEMPLATE_NAME=$(pveam available --section system | awk '/alpine/ {print $2; exit}')
        else
          TEMPLATE_NAME=$(pveam available --section system | awk 'NR==1{print $2}')
        fi
        echo "Chosen template: $TEMPLATE_NAME"
        # If no template present locally, try to download into 'local' storage
        if ! ls -1 /var/lib/vz/template/cache/* | grep -q "$(basename "$TEMPLATE_NAME" | sed 's/\\./\\./g')"; then
          if command -v sudo >/dev/null 2>&1; then SUDO=sudo; else SUDO=; fi
          $SUDO pveam update || true
          $SUDO pveam download local "$TEMPLATE_NAME"
        fi
        ls -l /var/lib/vz/template/cache/ | sed -n '1,200p'

    - name: E2E LXC lifecycle (pct create/start/stop/destroy)
      run: |
        set -euo pipefail
        LOG=e2e_lxc.log
        exec > >(tee -a "$LOG") 2>&1

        echo "[E2E] Detect template (vztmpl)"
        TPL=${TPL:-}
        if [ -z "${TPL}" ]; then
          TPL=$(pvesm list local --content vztmpl 2>/dev/null | awk '/vztmpl/ {print $1; exit}') || true
        fi
        if [ -z "${TPL}" ]; then
          TPL=$(ls -1 /var/lib/vz/template/cache/*.tar.* 2>/dev/null | head -n1) || true
        fi
        if [ -z "${TPL}" ]; then
          echo "No LXC template found (vztmpl). Please ensure a container template exists." >&2
          exit 1
        fi
        echo "Template: $TPL"

        echo "[E2E] Detect rootfs storage"
        ROOTFS=${ROOTFS:-}
        if [ -z "${ROOTFS}" ]; then
          if pvesm status | awk '{print $1}' | grep -q '^local-lvm$'; then ROOTFS=local-lvm; else ROOTFS=local; fi
        fi
        echo "ROOTFS: $ROOTFS"

        BRIDGE=${E2E_BRIDGE:-vmbr0}
        if ! ip -br link 2>/dev/null | awk '{print $1}' | grep -q "^${BRIDGE}$"; then
          # fallback to first vmbr*
          FB=$(ip -br link 2>/dev/null | awk '{print $1}' | grep -E '^vmbr[0-9]+' | head -n1 || true)
          if [ -n "$FB" ]; then BRIDGE=$FB; fi
        fi
        echo "BRIDGE: $BRIDGE"

        VMID=$(pvesh get /cluster/nextid)
        echo "VMID: $VMID"

        cleanup() {
          set +e
          echo "[E2E] Cleanup for VMID=$VMID"
          pct stop "$VMID" --timeout 30 >/dev/null 2>&1 || true
          pct destroy "$VMID" --purge 1 >/dev/null 2>&1 || true
        }
        trap cleanup EXIT

        echo "[E2E] Create"
        if echo "$TPL" | grep -q '^local:'; then
          pct create "$VMID" "$TPL" \
            -rootfs "${ROOTFS}:2" -memory 256 -hostname "gh-e2e-$VMID" \
            -net0 "name=eth0,bridge=$BRIDGE,ip=dhcp" -cores 1 -features nesting=1 -unprivileged 1
        else
          pct create "$VMID" "$TPL" \
            -rootfs "${ROOTFS}:2" -memory 256 -hostname "gh-e2e-$VMID" \
            -net0 "name=eth0,bridge=$BRIDGE,ip=dhcp" -cores 1 -features nesting=1 -unprivileged 1
        fi

        echo "[E2E] Start"
        pct start "$VMID"
        for i in $(seq 1 30); do
          if pct status "$VMID" | grep -q running; then break; fi
          sleep 2
        done
        pct status "$VMID"

        echo "[E2E] Exec sanity"
        pct exec "$VMID" -- sh -lc 'uname -a && id && echo ok'

        echo "[E2E] Stop"
        pct stop "$VMID" --timeout 60
        pct status "$VMID" || true

        echo "[E2E] Destroy"
        pct destroy "$VMID" --purge 1
        trap - EXIT

    - name: Upload E2E logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: proxmox-e2e-logs
        path: e2e_lxc.log
        retention-days: 7
