name: Security

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 0' # Run weekly on Sunday

jobs:
  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: goto-bus-stop/setup-zig@v2
        with:
          version: '0.13.0'
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcap-dev libseccomp-dev libyajl-dev
      - name: Check dependencies
        run: zig build test
        
  code-scan:
    name: Code Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: goto-bus-stop/setup-zig@v2
        with:
          version: '0.13.0'
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcap-dev libseccomp-dev libyajl-dev
      - name: Run Zig Security Checks
        run: |
          zig build -Doptimize=ReleaseSafe
          zig build test
          
  # secrets-scan:
  #   name: Secrets Scanning
  #   runs-on: ubuntu-latest
  #   if: false  # Disabled due to false positives
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Install gitleaks
  #       run: |
  #         curl -L https://github.com/zricethezav/gitleaks/releases/download/v8.18.2/gitleaks_8.18.2_linux_x64.tar.gz | tar xz
  #         sudo mv gitleaks /usr/local/bin/
  #     - name: Run gitleaks
  #       run: gitleaks detect --no-git --config .gitleaks.toml 