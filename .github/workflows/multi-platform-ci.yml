name: Multi-Platform CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run nightly builds to catch dependency issues
    - cron: '0 2 * * *'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================================================
  # BUILD MATRIX - Debian Linux only (Proxmox VE compatibility)
  # ============================================================================
  build-matrix:
    name: Build (Debian Linux ${{ matrix.arch }}, ${{ matrix.mode }})
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          # Debian Linux builds only
          - arch: amd64
            mode: debug
            target: x86_64-linux
          - arch: amd64
            mode: release
            target: x86_64-linux
          - arch: arm64
            mode: release
            target: aarch64-linux
          - arch: arm64
            mode: debug
            target: aarch64-linux

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: 0.13.0

    - name: Cache Zig dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/zig
          zig-cache
          zig-out
        key: ${{ runner.os }}-${{ matrix.arch }}-zig-${{ hashFiles('build.zig', 'build.zig.zon') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.arch }}-zig-

    - name: Install Debian/Proxmox dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libseccomp-dev \
          libsystemd-dev \
          pkg-config \
          qemu-user-static \
          zfsutils-linux

    - name: Configure cross-compilation (ARM64)
      if: matrix.arch == 'arm64'
      run: |
        sudo apt-get install -y gcc-aarch64-linux-gnu
        export CC=aarch64-linux-gnu-gcc
        export AR=aarch64-linux-gnu-ar

    - name: Build Proxmox LXCRI
      run: |
        zig build \
          -Dtarget=${{ matrix.target }} \
          -Doptimize=${{ matrix.mode == 'release' && 'ReleaseSafe' || 'Debug' }} \
          -Dcpu=baseline

    - name: Run unit tests
      if: matrix.arch == 'amd64'
      run: |
        zig build test \
          -Dtarget=${{ matrix.target }} \
          -Doptimize=${{ matrix.mode == 'release' && 'ReleaseSafe' || 'Debug' }}

    - name: Run integration tests (requires Proxmox VE for full testing)
      if: matrix.arch == 'amd64'
      run: |
        zig build test-integration \
          -Dtarget=${{ matrix.target }} \
          -Doptimize=${{ matrix.mode == 'release' && 'ReleaseSafe' || 'Debug' }}

    - name: Security scan (Debian compatibility)
      if: matrix.mode == 'release'
      run: |
        # Static analysis with Semgrep
        pip install semgrep
        semgrep --config=auto src/
        
        # Binary analysis with checksec
        sudo apt-get install -y checksec
        checksec --file=zig-out/bin/proxmox-lxcri

    - name: Performance benchmarks (Debian/Proxmox optimized)
      if: matrix.arch == 'amd64' && matrix.mode == 'release'
      run: |
        zig build benchmark
        
        # Upload benchmark results
        echo "BENCHMARK_RESULTS<<EOF" >> $GITHUB_ENV
        cat benchmark-results.json >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: proxmox-lxcri-debian-${{ matrix.arch }}-${{ matrix.mode }}
        path: |
          zig-out/bin/proxmox-lxcri*
          zig-out/lib/libproxmox-lxcri*
        retention-days: 30

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-debian-${{ matrix.arch }}-${{ matrix.mode }}
        path: |
          test-results.xml
          coverage-report.html
          benchmark-results.json
        retention-days: 30

  # ============================================================================
  # CONTAINER IMAGE BUILDS
  # ============================================================================
  build-container-images:
    name: Build Container Images
    needs: build-matrix
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Set up QEMU for multi-platform builds
      uses: docker/setup-qemu-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Download build artifacts (amd64)
      uses: actions/download-artifact@v4
      with:
        name: proxmox-lxcri-debian-amd64-release
        path: ./artifacts/amd64/

    - name: Download ARM64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: proxmox-lxcri-debian-arm64-release
        path: ./artifacts/arm64/

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=sha
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Build and push runtime image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./docker/Dockerfile.runtime
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          VERSION=${{ github.ref_name }}
          COMMIT_SHA=${{ github.sha }}
          BUILD_DATE=${{ github.event.head_commit.timestamp }}

    - name: Build and push development image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./docker/Dockerfile.dev
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build and push debug image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./docker/Dockerfile.debug
        platforms: linux/amd64
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:debug
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # ============================================================================
  # PACKAGE BUILDING - Debian only (for Proxmox VE)
  # ============================================================================
  build-packages:
    name: Build Debian Packages
    needs: build-matrix
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        codename: [bookworm, bullseye]  # Debian versions for Proxmox VE

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: proxmox-lxcri-debian-amd64-release
        path: ./artifacts/

    - name: Set up Debian packaging environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          devscripts \
          debhelper \
          build-essential \
          fakeroot \
          lintian

    - name: Build DEB package for Proxmox VE
      run: |
        ./packaging/build-deb.sh \
          --version ${{ github.ref_name }} \
          --distribution debian \
          --codename ${{ matrix.codename }} \
          --proxmox-ve-compatible

    - name: Test package installation on Debian
      run: |
        ./packaging/test-package.sh \
          --package ./packages/proxmox-lxcri-debian-${{ matrix.codename }}.deb \
          --distribution debian \
          --test-proxmox-integration

    - name: Upload Debian packages
      uses: actions/upload-artifact@v4
      with:
        name: packages-debian-${{ matrix.codename }}
        path: |
          packages/proxmox-lxcri-*.deb
          packages/proxmox-lxcri-*_amd64.deb
          packages/proxmox-lxcri-*_arm64.deb
        retention-days: 90

  # ============================================================================
  # HELM CHARTS
  # ============================================================================
  build-helm-charts:
    name: Build and Test Helm Charts
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.13.0'

    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: '1.28.0'

    - name: Set up kind (Kubernetes in Docker)
      uses: helm/kind-action@v1.8.0
      with:
        cluster_name: test-cluster
        kubectl_version: v1.28.0

    - name: Lint Helm charts
      run: |
        helm lint ./charts/proxmox-lxcri
        helm lint ./charts/proxmox-lxcri-operator

    - name: Template Helm charts
      run: |
        helm template proxmox-lxcri ./charts/proxmox-lxcri \
          --values ./charts/proxmox-lxcri/values-test.yaml \
          --output-dir ./test-output

    - name: Validate Kubernetes manifests
      run: |
        kubectl apply --dry-run=client -f ./test-output/

    - name: Install charts in test cluster
      run: |
        # Install operator
        helm install proxmox-lxcri-operator ./charts/proxmox-lxcri-operator \
          --wait --timeout 5m

        # Install runtime
        helm install proxmox-lxcri ./charts/proxmox-lxcri \
          --values ./charts/proxmox-lxcri/values-test.yaml \
          --wait --timeout 5m

    - name: Test chart functionality
      run: |
        # Wait for pods to be ready
        kubectl wait --for=condition=ready pod -l app=proxmox-lxcri --timeout=300s
        
        # Run smoke tests
        kubectl run test-container --image=alpine:latest --rm -it --restart=Never -- echo "Test successful"

    - name: Package Helm charts
      run: |
        helm package ./charts/proxmox-lxcri --destination ./packages/
        helm package ./charts/proxmox-lxcri-operator --destination ./packages/

    - name: Upload Helm packages
      uses: actions/upload-artifact@v4
      with:
        name: helm-charts
        path: packages/*.tgz
        retention-days: 90

  # ============================================================================
  # QUALITY GATES
  # ============================================================================
  quality-gates:
    name: Quality Gates
    needs: [build-matrix, build-container-images]
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download test artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: test-results-debian-*
        merge-multiple: true

    - name: Code coverage analysis
      run: |
        # Combine coverage reports from all platforms
        ./scripts/combine-coverage.sh
        
        # Check coverage thresholds
        ./scripts/check-coverage-thresholds.sh \
          --minimum-line-coverage 85 \
          --minimum-function-coverage 90 \
          --minimum-branch-coverage 80

    - name: Performance regression check
      run: |
        # Compare against baseline performance
        ./scripts/performance-regression-check.sh \
          --baseline-file ./benchmarks/baseline.json \
          --current-results benchmark-results.json \
          --max-regression 5%

    - name: Security vulnerability scan
      run: |
        # Scan dependencies for vulnerabilities
        ./scripts/vulnerability-scan.sh \
          --format json \
          --output security-report.json
        
        # Check for high/critical vulnerabilities
        ./scripts/check-vulnerabilities.sh \
          --report security-report.json \
          --fail-on critical,high

    - name: License compliance check
      run: |
        # Check all dependencies for license compatibility
        ./scripts/license-check.sh \
          --allowed-licenses MIT,Apache-2.0,BSD-3-Clause \
          --output license-report.json

    - name: Documentation completeness
      run: |
        # Check API documentation coverage
        ./scripts/doc-coverage.sh \
          --minimum-coverage 95% \
          --check-examples \
          --check-links

  # ============================================================================
  # RELEASE DEPLOYMENT
  # ============================================================================
  deploy-release:
    name: Deploy Release
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    needs: [build-packages, build-helm-charts, quality-gates]
    runs-on: ubuntu-22.04
    permissions:
      contents: write
      packages: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Create release notes
      run: |
        ./scripts/generate-release-notes.sh \
          --version ${{ github.ref_name }} \
          --output release-notes.md

    - name: Create GitHub release
      uses: softprops/action-gh-release@v1
      with:
        body_path: release-notes.md
        files: |
          packages/**/proxmox-lxcri-*
          helm-charts/*.tgz
        draft: false
        prerelease: ${{ contains(github.ref_name, 'rc') || contains(github.ref_name, 'beta') }}

    - name: Update Helm repository
      run: |
        # Update Helm chart repository
        ./scripts/update-helm-repo.sh \
          --charts helm-charts/*.tgz \
          --repository-url https://charts.proxmox-lxcri.org

    - name: Publish to package repositories
      run: |
        # Publish DEB packages to Proxmox VE compatible repository
        ./scripts/publish-deb.sh \
          --packages packages/**/*.deb \
          --repository-url https://repo.proxmox-lxcri.org/debian \
          --proxmox-ve-repo

    - name: Update documentation
      run: |
        # Deploy updated documentation
        ./scripts/deploy-docs.sh \
          --version ${{ github.ref_name }} \
          --deploy-url https://docs.proxmox-lxcri.org

  # ============================================================================
  # NOTIFICATION
  # ============================================================================
  notify:
    name: Notifications
    if: always()
    needs: [build-matrix, build-container-images, build-packages, quality-gates]
    runs-on: ubuntu-22.04
    
    steps:
    - name: Notify on success
      if: needs.build-matrix.result == 'success' && needs.quality-gates.result == 'success'
      run: |
        echo "✅ All builds and quality gates passed successfully!"
        # Add Slack/Discord/email notifications here

    - name: Notify on failure
      if: needs.build-matrix.result == 'failure' || needs.quality-gates.result == 'failure'
      run: |
        echo "❌ Build or quality gates failed!"
        # Add failure notifications here
